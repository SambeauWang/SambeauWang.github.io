<!doctype html><html class="theme-next mist use-motion"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css" rel="stylesheet" type="text/css"><link href="//fonts.useso.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css"><meta name="keywords" content="Python,"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2"><meta name="description" content="Django-REST入门"><meta property="og:type" content="article"><meta property="og:title" content="Django-REST入门"><meta property="og:url" content="https://sambeauwang.github.io/2017/02/21/Django-REST入门/index.html"><meta property="og:site_name" content="Sambeau"><meta property="og:description" content="Django-REST入门"><meta property="og:updated_time" content="2017-03-20T13:39:00.400Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Django-REST入门"><meta name="twitter:description" content="Django-REST入门"><script type="text/javascript" id="hexo.configuration">var NexT=window.NexT||{},CONFIG={scheme:"Mist",sidebar:{position:"left",display:"hide"},fancybox:!0,motion:!0,duoshuo:{userId:"0",author:"博主"}}</script><link rel="canonical" href="https://sambeauwang.github.io/2017/02/21/Django-REST入门/"><title>Django-REST入门 | Sambeau</title></head><body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans"><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-86063343-1","auto"),ga("send","pageview")</script><div class="container one-collumn sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="//schema.org/WPHeader"><div class="header-inner"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Sambeau</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section">首页</a></li><li class="menu-item menu-item-categories"><a href="/categories" rel="section">分类</a></li><li class="menu-item menu-item-archives"><a href="/archives" rel="section">归档</a></li><li class="menu-item menu-item-tags"><a href="/tags" rel="section">标签</a></li><li class="menu-item menu-item-schedule"><a href="/schedule" rel="section">日程</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="st-search-show-outputs">搜索</a></li></ul><div class="site-search"><form class="site-search-form"><input type="text" id="st-search-input" class="st-search-input st-default-search-input"></form><script type="text/javascript">!function(t,e,n,s,c,a,i){t.SwiftypeObject=c,t[c]=t[c]||function(){(t[c].q=t[c].q||[]).push(arguments)},a=e.createElement(n),i=e.getElementsByTagName(n)[0],a.async=1,a.src=s,i.parentNode.insertBefore(a,i)}(window,document,"script","//s.swiftypecdn.com/install/v2/st.js","_st"),_st("install","YjoQj_U5CFYfraaUGKBM","2.0.0")</script></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="//schema.org/Article"><header class="post-header"><h1 class="post-title" itemprop="name headline">Django-REST入门</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time itemprop="dateCreated" datetime="2017-02-21T09:25:12+08:00" content="2017-02-21">2017-02-21 </time></span><span class="post-category">&nbsp; | &nbsp; <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a href="/categories/Python-Django/" itemprop="url" rel="index"><span itemprop="name">Python Django</span> </a></span></span><span class="post-comments-count">&nbsp; | &nbsp; <a href="/2017/02/21/Django-REST入门/#comments" itemprop="discussionUrl"><span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/02/21/Django-REST入门/" itemprop="commentsCount"></span> </a></span><span id="/2017/02/21/Django-REST入门/" class="leancloud_visitors" data-flag-title="Django-REST入门">&nbsp; | &nbsp; <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数 </span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="创建一个新环境"><a href="#创建一个新环境" class="headerlink" title="创建一个新环境"></a>创建一个新环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">virtualenv env # 创建虚拟环境， 命名: env</div><div class="line">source env/bin/activate # 进入虚拟环境env</div><div class="line"></div><div class="line">pip install django</div><div class="line">pip install djangorestframework</div><div class="line">pip install pygments # 代码高亮插件</div><div class="line"></div><div class="line">django-admin.py startproject tutorial</div><div class="line">cd tutorial</div><div class="line"></div><div class="line">python manage.py startapp snippets</div><div class="line"></div><div class="line"># tutorial/settings.py</div><div class="line">INSTALLED_APPS = (</div><div class="line">...</div><div class="line">&apos;rest_framework&apos;,</div><div class="line">&apos;snippets&apos;,</div><div class="line">)</div></pre></td></tr></table></figure><h3 id="创建一个-Model"><a href="#创建一个-Model" class="headerlink" title="创建一个 Model"></a>创建一个 Model</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</div><div class="line"><span class="keyword">from</span> pygments.lexers <span class="keyword">import</span> get_all_lexers</div><div class="line"><span class="keyword">from</span> pygments.styles <span class="keyword">import</span> get_all_styles</div><div class="line"></div><div class="line">LEXERS = [item <span class="keyword">for</span> item <span class="keyword">in</span> get_all_lexers() <span class="keyword">if</span> item[<span class="number">1</span>]]</div><div class="line">LANGUAGE_CHOICES = sorted([(item[<span class="number">1</span>][<span class="number">0</span>], item[<span class="number">0</span>]) <span class="keyword">for</span> item <span class="keyword">in</span> LEXERS])</div><div class="line">STYLE_CHOICES = sorted((item, item) <span class="keyword">for</span> item <span class="keyword">in</span> get_all_styles())</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Snippet</span><span class="params">(models.Model)</span>:</span></div><div class="line">  created = models.DateTimeField(auto_now_add=<span class="keyword">True</span>)</div><div class="line">  title = models.CharField(max_length=<span class="number">100</span>, blank=<span class="keyword">True</span>, default=<span class="string">''</span></div><div class="line">  code = models.TextField()</div><div class="line">  linenos = models.BooleanField(default=<span class="keyword">False</span>)</div><div class="line">  language = models.CharField(choices=LANGUAGE_CHOICES, default=<span class="string">'python'</span></div><div class="line">  style = models.CharField(choices=STYLE_CHOICES, default=<span class="string">'friendly'</span></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">    ordering = (<span class="string">'created'</span>,)</div><div class="line"></div><div class="line">python manage.py makemigrations snippets</div><div class="line">python manage.py migrate</div></pre></td></tr></table></figure><h3 id="创建一个序列化类-serializers-py"><a href="#创建一个序列化类-serializers-py" class="headerlink" title="创建一个序列化类(serializers.py)"></a>创建一个序列化类(serializers.py)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</div><div class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet, LANGUAGE_CHOICES, STYLE_CHOICES</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetSerializer</span><span class="params">(serializers.Serializer)</span>:</span></div><div class="line">  pk = serializers.IntegerField(read_only=<span class="keyword">True</span>)</div><div class="line">  title = serializers.CharField(required=<span class="keyword">False</span>, allow_blank=<span class="keyword">True</span>, max_length=</div><div class="line">  code = serializers.CharField(style=&#123;<span class="string">'base_template'</span>: <span class="string">'textarea.html'</span></div><div class="line">  linenos = serializers.BooleanField(required=<span class="keyword">False</span>)</div><div class="line">  language = serializers.ChoiceField(choices=LANGUAGE_CHOICES, default=</div><div class="line">  style = serializers.ChoiceField(choices=STYLE_CHOICES, default=</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, validated_data)</span>:</span></div><div class="line">  <span class="string">"""</span></div><div class="line">  Create and return a new `Snippet` instance, given the validated data.</div><div class="line">  """</div><div class="line">    <span class="keyword">return</span> Snippet.objects.create(**validated_data)</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self, instance, validated_data)</span>:</span></div><div class="line">  <span class="string">"""</span></div><div class="line">  Update and return an existing `Snippet` instance, given the validated data.</div><div class="line">  """</div><div class="line">    instance.title = validated_data.get(<span class="string">'title'</span>, instance.title)</div><div class="line">    instance.code = validated_data.get(<span class="string">'code'</span>, instance.code)</div><div class="line">    instance.linenos = validated_data.get(<span class="string">'linenos'</span>, instance.linenos)</div><div class="line">    instance.language = validated_data.get(<span class="string">'language'</span>, instance.language)</div><div class="line">    instance.style = validated_data.get(<span class="string">'style'</span>, instance.style)</div><div class="line">    instance.save()</div><div class="line">    <span class="keyword">return</span> instance</div></pre></td></tr></table></figure><p>用序列化(Serializers)工作<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</div><div class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</div><div class="line"><span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span> JSONRenderer</div><div class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser</div><div class="line"></div><div class="line">snippet = Snippet(code=<span class="string">'foo = "bar"\n'</span>)</div><div class="line">snippet.save()</div><div class="line">snippet = Snippet(code=<span class="string">'print "hello, world"\n'</span>)</div><div class="line">snippet.save()</div><div class="line"></div><div class="line">serializer = SnippetSerializer(snippet)</div><div class="line">serializer.data</div><div class="line"><span class="comment"># &#123;'pk': 2, 'title': u'', 'code': u'print "hello, world"\n', 'linenos': False, 'language': ...&#125;</span></div><div class="line"></div><div class="line"><span class="comment"># Serializer -&gt; JSON</span></div><div class="line">content = JSONRenderer().render(serializer.data)</div><div class="line">content</div><div class="line"><span class="comment"># '&#123;"pk": 2, "title": "", "code": "print \\"hello, world\\"\\n", "linenos": false, "language...</span></div><div class="line"></div><div class="line"><span class="comment"># stream -&gt; json</span></div><div class="line"><span class="keyword">from</span> django.utils.six <span class="keyword">import</span> BytesIO</div><div class="line">stream = BytesIO(content)</div><div class="line">data = JSONParser().parse(stream)</div><div class="line"></div><div class="line"><span class="comment"># json -&gt; serializer</span></div><div class="line">serializer = SnippetSerializer(data=data)</div><div class="line">serializer.is_valid()</div><div class="line"><span class="comment"># True</span></div><div class="line">serializer.validated_data</div><div class="line"><span class="comment"># OrderedDict([('title', ''), ('code', 'print "hello, world"\n'), ('linenos', False), ('language', 'python'), ('style', 'friendly')])</span></div><div class="line">serializer.save()</div><div class="line"><span class="comment"># &lt;Snippet: Snippet object&gt;</span></div></pre></td></tr></table></figure><p></p><h3 id="使用模型序列化ModelSerializers"><a href="#使用模型序列化ModelSerializers" class="headerlink" title="使用模型序列化ModelSerializers"></a>使用模型序列化ModelSerializers</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">    model = Snippet</div><div class="line">    fields = (<span class="string">'id'</span>, <span class="string">'title'</span>, <span class="string">'code'</span>, <span class="string">'linenos'</span>, <span class="string">'language'</span>, <span class="string">'style'</span>)</div></pre></td></tr></table></figure><h3 id="用我们的序列化来写常规的Django视图"><a href="#用我们的序列化来写常规的Django视图" class="headerlink" title="用我们的序列化来写常规的Django视图"></a>用我们的序列化来写常规的Django视图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># snippets/views.py</span></div><div class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</div><div class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt</div><div class="line"><span class="keyword">from</span> rest_framework.renderers <span class="keyword">import</span> JSONRenderer</div><div class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser</div><div class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</div><div class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSONResponse</span><span class="params">(HttpResponse)</span>:</span></div><div class="line">  <span class="string">"""</span></div><div class="line">  An HttpResponse that renders its content into JSON.</div><div class="line">  """</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, data, **kwargs)</span>:</span></div><div class="line">    content = JSONRenderer().render(data)</div><div class="line">    kwargs[<span class="string">'content_type'</span>] = <span class="string">'application/json'</span></div><div class="line">    super(JSONResponse, self).__init__(content, **kwargs)</div><div class="line"></div><div class="line"><span class="meta">@csrf_exempt</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_detail</span><span class="params">(request, pk)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Retrieve, update or delete a code snippet.</div><div class="line">    """</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        snippet = Snippet.objects.get(pk=pk)</div><div class="line">    <span class="keyword">except</span> Snippet.DoesNotExist:</div><div class="line">        <span class="keyword">return</span> HttpResponse(status=<span class="number">404</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</div><div class="line">        serializer = SnippetSerializer(snippet)</div><div class="line">        <span class="keyword">return</span> JSONResponse(serializer.data)</div><div class="line">    <span class="keyword">elif</span> request.method == <span class="string">'PUT'</span>:</div><div class="line">        data = JSONParser().parse(request)</div><div class="line">        serializer = SnippetSerializer(snippet, data=data)</div><div class="line">      <span class="keyword">if</span> serializer.is_valid():</div><div class="line">          serializer.save()</div><div class="line">          <span class="keyword">return</span> JSONResponse(serializer.data)</div><div class="line">      <span class="keyword">return</span> JSONResponse(serializer.errors, status=<span class="number">400</span>)</div><div class="line">    <span class="keyword">elif</span> request.method == <span class="string">'DELETE'</span>:</div><div class="line">      snippet.delete()</div><div class="line">      <span class="keyword">return</span> HttpResponse(status=<span class="number">204</span>)</div></pre></td></tr></table></figure><p>我们需要用线将这些视图连起来。 创建 snippets/urls.py 文件:<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</div><div class="line"><span class="keyword">from</span> snippets <span class="keyword">import</span> views</div><div class="line">urlpatterns = [</div><div class="line">        url(<span class="string">r'^snippets/$'</span>, views.snippet_list),</div><div class="line">        url(<span class="string">r'^snippets/(?P&lt;pk&gt;[0-9]+)/$'</span>, views.snippet_detail),</div><div class="line">]</div></pre></td></tr></table></figure><p></p><h2 id="请求与响应"><a href="#请求与响应" class="headerlink" title="请求与响应"></a>请求与响应</h2><p>REST框架介绍了一个 请求(Request) 对象， 它扩展了常规的 HttpResquest ，并且提供更灵活的请求解析。<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">request.POST <span class="comment"># 只处理表单数据。 只对'POST'方法起作用。</span></div><div class="line">request.data <span class="comment"># 可以处理任意数据。 对'POST'， 'PUT'和'PATCH'方法起作用。</span></div></pre></td></tr></table></figure><p></p><p>REST 框架也介绍了 Response 对象， 它是一类用未渲染内容和内容协商来决定正确的内容类型并把它返回给客户端的 模板响应<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> Response(data) <span class="comment"># 根据客户端的请求来渲染成指定的内容类型。</span></div></pre></td></tr></table></figure><p></p><p>REST框架为每个状态码(status code)提供更明确的标识符， 例如在 状态(status) 模型中的 HTTP_400_BAD_REQUEST 。 用这些标识符代替纯数字的HTTP状态码是很好的注意。</p><h3 id="装饰API视图"><a href="#装饰API视图" class="headerlink" title="装饰API视图"></a>装饰API视图</h3><ul><li>@api_view 装饰器用在基于视图的方法上。</li><li>APIView 类用在基于视图的类上。 这些装饰器提供一些功能</li></ul><p>例如去报在你的视图中接收 Request 对象， 例如在你的 Response 对象中添加上下文，这样我们就能实现内容通信。 这里装饰器也提供了一些行为， 例如在合适的时候返回 405 Method Not Allowed 响应， 例如处理任何在访问错误输入的 request.data 时出现的 解析错误(ParseError) 异常。</p><h3 id="结合在一起"><a href="#结合在一起" class="headerlink" title="结合在一起"></a>结合在一起</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</div><div class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> api_view</div><div class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</div><div class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</div><div class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</div><div class="line"></div><div class="line"><span class="meta">@api_view(['GET', 'PUT', 'DELETE'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_detail</span><span class="params">(request, pk)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Retrieve, update or delete a snippet instance.</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        snippet = Snippet.objects.get(pk=pk)</div><div class="line">    <span class="keyword">except</span> Snippet.DoesNotExist:</div><div class="line">        <span class="keyword">return</span> Response(status=status.HTTP_404_NOT_FOUND)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'GET'</span>:</div><div class="line">        serializer = SnippetSerializer(snippet)</div><div class="line">        <span class="keyword">return</span> Response(serializer.data)</div><div class="line">    <span class="keyword">elif</span> request.method == <span class="string">'PUT'</span>:</div><div class="line">        serializer = SnippetSerializer(snippet, data=request.data)</div><div class="line">        <span class="keyword">if</span> serializer.is_valid():</div><div class="line">            serializer.save()</div><div class="line">            <span class="keyword">return</span> Response(serializer.data)</div><div class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</div><div class="line">    <span class="keyword">elif</span> request.method == <span class="string">'DELETE'</span>:</div><div class="line">        snippet.delete()</div><div class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</div></pre></td></tr></table></figure><p><strong>我们不再明确打印我们的对指定内容类型的请求或响应。 request.data 能够处理 json 请求， 但是它也能处理其他格式。 相似地， 虽然我们可以在响应对象中带数据， 但允许REST框架渲染响应成正确的内容类型。</strong></p><h3 id="在我们的链接-URLs-后添加可选格式后缀"><a href="#在我们的链接-URLs-后添加可选格式后缀" class="headerlink" title="在我们的链接(URLs)后添加可选格式后缀"></a>在我们的链接(URLs)后添加可选格式后缀</h3><p>为了利用我们的响应内容不再是单一格式的事实， 我们应该为我们的API尾部添加格式后缀。 用格式后缀给我们明确参考指定格式的URL， 这意味着我们的API能够处理像 <a href="http://example.com/api/items/4/.json" target="_blank" rel="external">http://example.com/api/items/4/.json</a> 一样的链接。 在视图函数中添加一个 format 参数， 像这样：<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">snippet_list</span><span class="params">(request, pk, fornat=None)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="comment"># urls.py</span></div><div class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</div><div class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</div><div class="line"><span class="keyword">from</span> snippets <span class="keyword">import</span> views</div><div class="line"></div><div class="line">urlpatterns = [</div><div class="line">    url(<span class="string">r'^snippets/$'</span>, views.snippet_list),</div><div class="line">    url(<span class="string">r'^snippets/(?P&lt;pk&gt;[0-9]+)$'</span>, views.snippet_detail),</div><div class="line">]</div><div class="line"></div><div class="line">rlpatterns = format_suffix_patterns(urlpatterns)</div></pre></td></tr></table></figure><p></p><p>因为API是基于客户端请求来选择响应内容的类型， 所以默认情况下， 在Web浏览器访问资源时， API返回HTML格式的资源。 这语序API返回完全可以网页浏览的HTML。 有可以网页浏览API是很好的， 这使开发和使用你的API更简单， 这也为其他想要查看和使用你的API的开发者大大降低了门槛。</p><h3 id="基于视图的类"><a href="#基于视图的类" class="headerlink" title="基于视图的类"></a>基于视图的类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># views.py</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetDetail</span><span class="params">(APIView)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Retrieve, update or delete a snippet instance.</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span><span class="params">(self, pk)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">return</span> Snippet.objects.get(pk=pk)</div><div class="line">        <span class="keyword">except</span> Snippet.DoesNotExist:</div><div class="line">            <span class="keyword">raise</span> Http404</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, pk, format=None)</span>:</span></div><div class="line">        snippet = self.get_object(pk)</div><div class="line">        serializer = SnippetSerializer(snippet)</div><div class="line">        <span class="keyword">return</span> Response(serializer.data)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, request, pk, format=None)</span>:</span></div><div class="line">        snippet = self.get_object(pk)</div><div class="line">        serializer = SnippetSerializer(snippet, data=request.data)</div><div class="line">        <span class="keyword">if</span> serializer.is_valid():</div><div class="line">            serializer.save()</div><div class="line">            <span class="keyword">return</span> Response(serializer.data)</div><div class="line">        <span class="keyword">return</span> Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, request, pk, format=None)</span>:</span></div><div class="line">        snippet = self.get_object(pk)</div><div class="line">        snippet.delete()</div><div class="line">        <span class="keyword">return</span> Response(status=status.HTTP_204_NO_CONTENT)</div><div class="line"></div><div class="line"><span class="comment"># urls.py</span></div><div class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</div><div class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</div><div class="line"><span class="keyword">from</span> snippets <span class="keyword">import</span> views</div><div class="line">urlpatterns = [</div><div class="line">    url(<span class="string">r'^snippets/$'</span>, views.SnippetList.as_view()),</div><div class="line">    url(<span class="string">r'^snippets/(?P&lt;pk&gt;[0-9]+)/$'</span>, views.SnippetDetail.as_view()),</div><div class="line">]</div><div class="line"></div><div class="line">rlpatterns = format_suffix_patterns(urlpatterns)</div></pre></td></tr></table></figure><h3 id="使用混合"><a href="#使用混合" class="headerlink" title="使用混合"></a>使用混合</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> snippets.models <span class="keyword">import</span> Snippet</div><div class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> SnippetSerializer</div><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> mixins</div><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> generics</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetList</span><span class="params">(mixins.ListModelMixin,</span></span></div><div class="line">                  mixins.CreateModelMixin,</div><div class="line">                  generics.GenericAPIView):</div><div class="line">    queryset = Snippet.objects.all()</div><div class="line">    serializer_class = SnippetSerializer</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.list(request, *args, **kwargs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.create(request, *args, **kwargs)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, request, *args, **kwargs)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.destroy(request, *args, **kwargs)</div></pre></td></tr></table></figure><h2 id="授权与权限"><a href="#授权与权限" class="headerlink" title="授权与权限"></a>授权与权限</h2><p>我们打算对我们的 Snippet 模型类做些改变。 首先， 让我们添加几个字段。 其中一个字段将显示出哪个用户创建里snippet数据。 另一个字段将用于HTML代码高亮。<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">owner = models.ForeignKey(<span class="string">'auth.User'</span>, related_name=<span class="string">'snippets'</span>)</div><div class="line">highlighted = models.TextField()</div><div class="line"></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(self, *args, **kwargs)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Use the `pygments` library to create a highlighted HTML</div><div class="line">    representation of the code snippet.</div><div class="line">    """</div><div class="line">    lexer = get_lexer_by_name(self.language)</div><div class="line">    linenos = self.linenos <span class="keyword">and</span> <span class="string">'table'</span> <span class="keyword">or</span> <span class="keyword">False</span></div><div class="line">    options = self.title <span class="keyword">and</span> &#123;<span class="string">'title'</span>: self.title&#125; <span class="keyword">or</span> &#123;&#125;</div><div class="line">    formatter = HtmlFormatter(style=self.style, linenos=linenos,</div><div class="line">    full=<span class="keyword">True</span>, **options)</div><div class="line">    self.highlighted = highlight(self.code, lexer, formatter)</div><div class="line">    super(Snippet, self).save(*args, **kwargs)</div></pre></td></tr></table></figure><p></p><p>既然我们已经创建了多个用户， 那么我们最好将用户添加到我们的API。 很容易创建一个新的序列。 在 serializers.py 中添加<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></div><div class="line">    snippets = serializers.PrimaryKeyRelatedField(many=<span class="keyword">True</span>, queryset=Snippet.objects.all())</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        model = User</div><div class="line">        fields = (<span class="string">'id'</span>, <span class="string">'username'</span>, <span class="string">'snippets'</span>)</div></pre></td></tr></table></figure><p></p><p>我们需要添加在 views.py 中添加一些视图。 我们想要为用户添加只读视图， 所以我们会使用基于视图的一般类 ListAPIView 和 RetrieveAPIView 。<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> snippets.serializers <span class="keyword">import</span> UserSerializer</div><div class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserList</span><span class="params">(generics.ListAPIView)</span>:</span></div><div class="line">    queryset = User.objects.all()</div><div class="line">      serializer_class = UserSerializer</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserDetail</span><span class="params">(generics.RetrieveAPIView)</span>:</span></div><div class="line">    queryset = User.objects.all()</div><div class="line">    serializer_class = UserSerializer</div><div class="line"></div><div class="line"><span class="comment"># urls.py</span></div><div class="line">url(<span class="string">r'^users/$'</span>, views.UserList.as_view()),</div><div class="line">url(<span class="string">r'^users/(?P&lt;pk&gt;[0-9]+)/$'</span>, views.UserDetail.as_view()),</div></pre></td></tr></table></figure><p></p><p><strong>如果我们创建snippet数据， 我们没办法将用户和snippet实例联系起来。 虽然用户不是序列表示的部分， 但是它是请求的一个属性。 我们通过重写snippet视图的 .perform_create() 方法来做到， 这个方法允许我们修改如何保存实例， 修改任何请求对象或者请求连接里的信息。 在 SnippetList 视图类中添加以下方法；</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">perform_create</span><span class="params">(self, serializer)</span>:</span></div><div class="line">    serializer.save(owner=self.request.user)</div></pre></td></tr></table></figure><p></p><p>我们序列的 create() 方法将会另外传入一个来自有效的请求数据的 ‘owner’ 字段。</p><h3 id="更新snippet序列"><a href="#更新snippet序列" class="headerlink" title="更新snippet序列"></a>更新snippet序列</h3><p><strong>既然已经将snippets和创建它们的用户联系在一起了， 那么我们需要更新对应的 SnippetSerializer 。 在 serializers.py 的序列定义(serializer definition)中添加以下字段：</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">owner = serializers.ReadOnlyField(source=<span class="string">'owner.username'</span>)</div></pre></td></tr></table></figure><p></p><p><strong>去报你也添加 ‘owner’, 到内部类 Meta 的字段列表里。 这个字段很有趣。 source 参数控制哪个属性被用于构成一个字段， 并且能够指出序列实例的任何属性。 它也能想上面一样使用点标记(.)， 这中情况下他会横贯给定的属性， 就是我们使用Django模板语言一样。 *</strong></p><h3 id="为视图添加权限"><a href="#为视图添加权限" class="headerlink" title="为视图添加权限"></a>为视图添加权限</h3><p>snippets数据已经和用户联系在一起， 我们想确保只有授权的用户可以创建、 更新和删除snippet数据。 REST框架包括许多权限类(permission classes)， 我们可以使用这些权限类来现在视图的访问权限。 这种情况下， 其中我们需要 IsAuthenticatedOrReadOnly ， 这个类确保授权请求有读写权限， 而没有授权的用户只有只读权限。 首先， 在视图模块中引入以下代码<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> permissions</div><div class="line"></div><div class="line"><span class="comment"># SnippetList 和 SnippetDetail 视图类中</span></div><div class="line">permission_classes = (permissions.IsAuthenticatedOrReadOnly, )</div></pre></td></tr></table></figure><p></p><p>如果你现在用浏览器打开API， 你会发现你已经不能创建新的snippets数据。 为此，我们需要以用户身份登录。 为了使用浏览器打开API， 我们需要添加一个登录视图， 编辑URL配置(URLconf)文件 urls.py 文件。 在 urls.py 顶部添加下面import。<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> include</div><div class="line"></div><div class="line">urlpatterns += [</div><div class="line">    url(<span class="string">r'^api-auth/'</span>, include(<span class="string">'rest_framework.urls'</span>,</div><div class="line">    namespace=<span class="string">'rest_framework'</span>)),</div><div class="line">]</div></pre></td></tr></table></figure><p></p><p>现在如果你刷新浏览器页面， 你会看到右上角的’Login’链接。 如果你用之前创建的用户登录， 你就可以再次写snippets数据了。一旦你创建snippets数据， 浏览’/users/‘， 然后你会发现在每个用户的’snippets’字段， 显示的内容包括与每个用户相关的snippets主键。</p><h3 id="视图集和路由"><a href="#视图集和路由" class="headerlink" title="视图集和路由"></a>视图集和路由</h3><p>视图集重写当前视图。 首先， 我们要把我们的 UserList 和 UserDetail 视图重写成单个 UserViewSet 。 我们可以 UserViewSet 代替 UserList 和 UserDetail 。<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span><span class="params">(viewsets.ReadOnlyModelViewSet)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    This viewset automatically provides `list` and `detail` actions.</div><div class="line">    """</div><div class="line">    queryset = User.objects.all()</div><div class="line">    serializer_class = UserSerializer</div><div class="line"></div><div class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> detail_route</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SnippetViewSet</span><span class="params">(viewsets.ModelViewSet)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    This viewset automatically provides `list`, `create`, `retrieve`,</div><div class="line">    `update` and `destroy` actions.</div><div class="line">    Additionally we also provide an extra `highlight` action.</div><div class="line">    """</div><div class="line"></div><div class="line">    queryset = Snippet.objects.all()</div><div class="line">    serializer_class = SnippetSerializer</div><div class="line">    permission_classes = (permissions.IsAuthenticatedOrReadOnly,</div><div class="line">                          IsOwnerOrReadOnly,)</div><div class="line"></div><div class="line"><span class="meta">    @detail_route(renderer_classes=[renderers.StaticHTMLRenderer])</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">highlight</span><span class="params">(self, request, *args, **kwargs)</span>:</span></div><div class="line">        snippet = self.get_object()</div><div class="line">        <span class="keyword">return</span> Response(snippet.highlighted)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span><span class="params">(self, serializer)</span>:</span></div><div class="line">        serializer.save(owner=self.request.user)</div></pre></td></tr></table></figure><p></p><p><strong>这次我们使用 ModelViewSet 类是为了获得完整的默认读写操作的集合。 注意：我们也用了 @detail_route 装饰器来创建自定义动作， 命名为 highlight 。 这<br>个装饰器用于添加任何自定义的端点， 这些端点不符合标准的 create/update/delete 方式。 使用 @detail_route 装饰器的自定义动作会响应 GET 请求。 如果我们让动作响应 POST 请求， 我们可以使用 methods 参数。 自定义动作的URL在默认情况下是依赖于方法本身。 如果你想改变url本来创建的方式， 你可以将url_path包含在装饰器关键参数中。</strong></p><h3 id="明确绑定viewset到URL"><a href="#明确绑定viewset到URL" class="headerlink" title="明确绑定viewset到URL"></a>明确绑定viewset到URL</h3><p><strong>我们定义URLConf的时候， 处理方法只绑定了动作。 为了看看发生了什么， 我们必须从我们的视图集(ViewSets)创建一个视图集合。 在 urls.py 文件中， 我们将 ViewSet 类绑定到具体视图的集合。</strong><br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> snippets.views <span class="keyword">import</span> SnippetViewSet, UserViewSet, api_root</div><div class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> renderers</div><div class="line"></div><div class="line">snippet_list = SnippetViewSet.as_view(&#123;</div><div class="line">    <span class="string">'get'</span>: <span class="string">'list'</span>,</div><div class="line">    <span class="string">'post'</span>: <span class="string">'create'</span></div><div class="line">&#125;)</div><div class="line"></div><div class="line">snippet_detail = SnippetViewSet.as_view(&#123;</div><div class="line">    <span class="string">'get'</span>: <span class="string">'retrieve'</span>,</div><div class="line">    <span class="string">'put'</span>: <span class="string">'update'</span>,</div><div class="line">    <span class="string">'patch'</span>: <span class="string">'partial_update'</span>,</div><div class="line">    <span class="string">'delete'</span>: <span class="string">'destroy'</span></div><div class="line">&#125;)</div><div class="line"></div><div class="line">snippet_highlight = SnippetViewSet.as_view(&#123;</div><div class="line">    <span class="string">'get'</span>: <span class="string">'highlight'</span></div><div class="line">&#125;, renderer_classes=[renderers.StaticHTMLRenderer])</div><div class="line"></div><div class="line">user_list = UserViewSet.as_view(&#123;</div><div class="line">    <span class="string">'get'</span>: <span class="string">'list'</span></div><div class="line">&#125;)</div><div class="line"></div><div class="line">user_detail = UserViewSet.as_view(&#123;</div><div class="line"><span class="string">'get'</span>: <span class="string">'retrieve'</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure><p></p><p>注意我们如何通过绑定http方法到每个视图需要的动作来从 ViewSet 类创建多视图。 既然我们已经绑定了我们的资源和具体视图， 我们就可以和以前一样将我们的视图注册到URL配置中。<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">urlpatterns = format_suffix_patterns([</div><div class="line">    url(<span class="string">r'^$'</span>, api_root),</div><div class="line">    url(<span class="string">r'^snippets/$'</span>, snippet_list, name=<span class="string">'snippet-list'</span>),</div><div class="line">    url(<span class="string">r'^snippets/(?P&lt;pk&gt;[0-9]+)/$'</span>, snippet_detail, name=<span class="string">'snippet-detail'</span>),</div><div class="line">    url(<span class="string">r'^snippets/(?P&lt;pk&gt;[0-9]+)/highlight/$'</span>, snippet_highlight, name=<span class="string">'snippet-highlight'</span>),</div><div class="line">    url(<span class="string">r'^users/$'</span>, user_list, name=<span class="string">'user-list'</span>),</div><div class="line">    url(<span class="string">r'^users/(?P&lt;pk&gt;[0-9]+)/$'</span>, user_detail, name=<span class="string">'user-detail'</span>)</div><div class="line">])</div></pre></td></tr></table></figure><p></p><h3 id="使用路由"><a href="#使用路由" class="headerlink" title="使用路由"></a>使用路由</h3><p>因为我们使用 ViewSet 类而不是 View 类， 所以实际上我们不需要自己设计URL配置。 按惯例， 使用 Router 类就可以自动将资源与视图(views)、 链接(urls)联系起来。 我们需要做的只是用一个路由注册合适的视图集合。 现在， 我们把剩下的做完。 我们重写了 urls.py 文件。<br></p><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url, include</div><div class="line"><span class="keyword">from</span> snippets <span class="keyword">import</span> views</div><div class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</div><div class="line"></div><div class="line"><span class="comment"># Create a router and register our viewsets with it.</span></div><div class="line">router = DefaultRouter()</div><div class="line">router.register(<span class="string">r'snippets'</span>, views.SnippetViewSet)</div><div class="line">router.register(<span class="string">r'users'</span>, views.UserViewSet)</div><div class="line"></div><div class="line"><span class="comment"># The API URLs are now determined automatically by the router.</span></div><div class="line"><span class="comment"># Additionally, we include the login URLs for the browsable API.</span></div><div class="line">urlpatterns = [</div><div class="line">      url(<span class="string">r'^'</span>, include(router.urls)),</div><div class="line">      url(<span class="string">r'^api-auth/'</span>, include(<span class="string">'rest_framework.urls'</span>, namespace=<span class="string">'rest_framework'</span></div><div class="line">]</div></pre></td></tr></table></figure><p></p><p><strong>用路由注册视图和提供一个urlpattern是相似的， 包括两个参数–视图的URL前缀和视图本身。 我们使用的 默认路由(DefaultRouter) 类会自动为我们创建API根视图， 所以我们就可以从我们的 views 模块删除 api_root 方法。</strong></p></div><div></div><div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Python/" rel="tag">#Python</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/02/18/Django入门/" rel="next" title="Django入门"><i class="fa fa-chevron-left"></i> Django入门</a></div><div class="post-nav-prev post-nav-item"><a href="/2017/02/25/libevent入门/" rel="prev" title="libevent入门">libevent入门 <i class="fa fa-chevron-right"></i></a></div></div></footer></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview">站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Sambeau Wang"><p class="site-author-name" itemprop="name">Sambeau Wang</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives"><span class="site-state-item-count">24</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories"><span class="site-state-item-count">6</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags"><span class="site-state-item-count">5</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/SambeauWang" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub </a></span><span class="links-of-author-item"><a href="sambeauwang@gmail.com" target="_blank" title="Gmail"><i class="fa fa-fw fa-gmail"></i> Gmail</a></span></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建一个新环境"><span class="nav-number">1.</span> <span class="nav-text">创建一个新环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建一个-Model"><span class="nav-number">2.</span> <span class="nav-text">创建一个 Model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建一个序列化类-serializers-py"><span class="nav-number">3.</span> <span class="nav-text">创建一个序列化类(serializers.py)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用模型序列化ModelSerializers"><span class="nav-number">4.</span> <span class="nav-text">使用模型序列化ModelSerializers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#用我们的序列化来写常规的Django视图"><span class="nav-number">5.</span> <span class="nav-text">用我们的序列化来写常规的Django视图</span></a></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#请求与响应"><span class="nav-number"></span> <span class="nav-text">请求与响应</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#装饰API视图"><span class="nav-number">1.</span> <span class="nav-text">装饰API视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#结合在一起"><span class="nav-number">2.</span> <span class="nav-text">结合在一起</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在我们的链接-URLs-后添加可选格式后缀"><span class="nav-number">3.</span> <span class="nav-text">在我们的链接(URLs)后添加可选格式后缀</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基于视图的类"><span class="nav-number">4.</span> <span class="nav-text">基于视图的类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用混合"><span class="nav-number">5.</span> <span class="nav-text">使用混合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#授权与权限"><span class="nav-number"></span> <span class="nav-text">授权与权限</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#更新snippet序列"><span class="nav-number">1.</span> <span class="nav-text">更新snippet序列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为视图添加权限"><span class="nav-number">2.</span> <span class="nav-text">为视图添加权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#视图集和路由"><span class="nav-number">3.</span> <span class="nav-text">视图集和路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#明确绑定viewset到URL"><span class="nav-number">4.</span> <span class="nav-text">明确绑定viewset到URL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用路由"><span class="nav-number">5.</span> <span class="nav-text">使用路由</span></a></li></ol></li></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2017</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Sambeau Wang</span></div><div class="powered-by"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>本站总访问量 <span id="busuanzi_value_site_pv"></span> &nbsp&nbsp&nbsp 您是第<span id="busuanzi_value_site_uv"></span>个来到的小伙伴</div><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script><script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script><script type="text/javascript">function run_disqus_script(s){var i=document.createElement("script");i.type="text/javascript",i.async=!0,i.src="//"+disqus_shortname+".disqus.com/"+s,(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(i)}var disqus_shortname="sambeaublog.disqus.com/admin",disqus_identifier="2017/02/21/Django-REST入门/",disqus_title="Django-REST入门",disqus_url="https://sambeauwang.github.io/2017/02/21/Django-REST入门/";run_disqus_script("count.js");var disqus_config=function(){this.page.url=disqus_url,this.page.identifier=disqus_identifier,this.page.title=disqus_title};run_disqus_script("embed.js")</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script><script>AV.initialize("MmTla9uHtyvAotAPz2aHArnn-gzGzoHsz","ppTjU9IN1rosOHlnsYjpxXJe")</script><script>function showTime(e){var t=new AV.Query(e),n=[],o=$(".leancloud_visitors");o.each(function(){n.push($(this).attr("id").trim())}),t.containedIn("url",n),t.find().done(function(e){var t=".leancloud-visitors-count";if(0===e.length)return void o.find(t).text(0);for(var i=0;i<e.length;i++){var r=e[i],s=r.get("url"),l=r.get("time"),c=document.getElementById(s);$(c).find(t).text(l)}for(var i=0;i<n.length;i++){var s=n[i],c=document.getElementById(s),u=$(c).find(t);""==u.text()&&u.text(0)}}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(e){var t=$(".leancloud_visitors"),n=t.attr("id").trim(),o=t.attr("data-flag-title").trim(),i=new AV.Query(e);i.equalTo("url",n),i.find({success:function(t){if(t.length>0){var i=t[0];i.fetchWhenSave(!0),i.increment("time"),i.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var r=new e,s=new AV.ACL;s.setPublicReadAccess(!0),s.setPublicWriteAccess(!0),r.setACL(s),r.set("title",o),r.set("url",n),r.set("time",1),r.save(null,{success:function(e){var t=$(document.getElementById(n));t.find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):$(".post-title-link").length>1&&showTime(e)})</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script></body></html>